<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Critical Eye</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
  <style>
    :required {
      border-color: red;
    }
    :required:valid {
      border-color: green;
    }
    .result {
      list-style: none;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h1>Critical Eye</h1>
    <div class="row">
      <div class="col-sm-6">
        <form id="search_album" class="form form-inline" >
          <div class="form-group">
            <label for="q" class="sr-only">Search Query:</label>
            <input type="text" name="q" id="q" placeholder="Album Name" class="form-control">
          </div>
          <button type="submit" class="btn btn-primary">Search</button>
        </form>

        <div id="search_results"></div>

        <form id="add_listened" class="form">
          <div class="form-group">
            <label for="artist">Artist</label>
            <input type="text" placeholder="Artist" id="artist" name="artist" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="album">Album</label>
            <input type="text" placeholder="Album" id="album" name="album" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="spotifyId">Spotify ID</label>
            <input type="text" id="spotifyId" placeholder="Spotify ID" name="spotifyId" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="artwork">Artwork URL</label>
            <input type="url" id="artwork" placeholder="http://" name="artwork" class="form-control">
          </div>

          <div class="form-group">
            <label for="href">Listen URL</label>
            <input type="url" id="href" name="href" placeholder="http://" class="form-control">
          </div>

          <div class="form-group">
            <label for="dateListened">Date Listened</label>
            <input type="datetime-local" id="dateListened" name="dateListened" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="rating">Rating</label>
            <input type="number" min="0" max="5" step="0.5" placeholder="2.5" id="rating" name="rating" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" class="form-control"></textarea>
          </div>

          <button type="submit" class="btn btn-primary">Save</button>
        </form>
      </div>
      <div class="col-sm-6" id="listened">
      </div>
    </div>
  </div>
  <script id="search-template" type="text/x-handlebars-template">
    <ul>
      {{#each albums}}
        <li class="result"
          data-spotify-id="{{spotifyId}}"
          data-artist="{{artist}}"
          data-album="{{album}}"
          data-artwork="{{artwork}}"
          data-href="{{href}}">
          <img src="{{artwork}}" width="45"> {{artist}}: {{album}}
          <div class="btn-group btn-group-sm" role="group" aria-label="...">
            <a class="btn btn-sm btn-success" href="{{href}}" target="_blank">Listen</a>
            <button class="btn btn-sm btn-default review_button">Review</button>
          </div>
        </li>
      {{/each}}
    </ul>
  </script>
  <script id="listened-template" type="text/x-handlebars-template">
    <table class="table table=striped">
      <thead>
        <tr>
          <th>Artwork</th>
          <th>Rating</th>
          <th>Artist</th>
          <th>Album</th>
          <th>Date Listened</th>
        </tr>
      </thead>
      <tbody>
        {{#each albums}}
          <tr id="{{spotifyId}}" class="album_row">
            <td><img src="{{artwork}}"></td>
            <td>{{rating}}</td>
            <td>{{artist}}</a></td>
            <td><a href="{{href}}" target="_blank">{{album}}</a></td>
            <td>{{dateListened}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>
  </script>
  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js"></script>
  <script>
    const listened_source = document.getElementById('listened-template').innerHTML;
    const listened_tmpl = Handlebars.compile(listened_source);
    const listended_container = document.getElementById('listened');

    const search_source = document.getElementById('search-template').innerHTML;
    const search_tmpl = Handlebars.compile(search_source);
    const search_container = document.getElementById('search_results');
  </script>
  <script>
    const album_collection = [];
    const add_listened = document.getElementById('add_listened');

    const db = new Dexie("albums_listened");
    db.version(1).stores({
      albums: '++id, rating, &spotifyId, dateListened, artwork, album, artist, href, description'
    });

    db.open().catch(e => {
      console.error(`Open failed: ${e}`);
    });

    get_albums();

    async function get_albums() {
      const albums = await db.albums.toArray();
      const formatted = albums.map(build_album_data);

      listended_container.innerHTML = listened_tmpl({albums: formatted});
    }

    function build_album_data(album) {
      return Object.assign({}, album, {
        rating: number_to_stars(album.rating),
        dateListened: human_date(album.dateListened),
      });
    }

    function number_to_stars(num) {
      const wholes = Math.floor(num);
      const remainder = (num % 1).toString().split('.')[1];
      let rating = "â˜…".repeat(wholes);
      if (remainder) {
        rating += '.' + remainder;
      }

      return rating;
    }

    function human_date(date) {
      console.log(date);
      return new Date(date).toDateString();
    }

    // Set Date Listened default
    document.getElementById('dateListened').value = new Date().toISOString().slice(0,-8);

    // Search for albums
    const search_album = document.getElementById('search_album');
    search_album.addEventListener('submit', async e => {
      e.preventDefault();
      const query          = e.target.q.value;
      const search_json    = await fetch(`https://api.spotify.com/v1/search?q=${query}&type=album`)
      const search_results = await search_json.json();

      const formatted = search_results.albums.items.map(album => ({
        spotifyId: album.id,
        artist: album.artists.map(artist => artist.name).join(','),
        album: album.name,
        href: album.external_urls.spotify,
        artwork: album.images[2].url
      }));

      search_container.innerHTML = search_tmpl({albums: formatted});

      // When review is clicked, fill out form data.
      const review_buttons = document.querySelectorAll('.review_button');
      Array.from(review_buttons).forEach(button => {
        button.addEventListener('click', e => {
          const album = e.target.closest('.result');

          add_listened.artist.value = album.dataset.artist;
          add_listened.album.value = album.dataset.album;
          add_listened.spotifyId.value = album.dataset.spotifyId;
          add_listened.artwork.value = album.dataset.artwork;
          add_listened.href.value = album.dataset.href;
          // Clear out search results
          search_container.innerHTML = '';
        });
      });
    });

    // Save listened
    add_listened.addEventListener('submit', e => {
      e.preventDefault();
      const album_data = new FormData(add_listened);
      const album = {};
      for (let [key, value] of album_data.entries()) {
        album[key] = value;
      }
      db.albums.add(album).then(() => {
        window.location.reload();
      });
    });
  </script>
</body>
</html>